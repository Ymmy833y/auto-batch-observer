<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <title>Auto Batch Observer</title>
</head>

<body>
  <header class="container-lg my-3">
    <div class=" d-flex justify-content-between">
      <h1 class="fs-2">Auto Batch Observer</h1>
    </div>
    <hr>
  </header>
  <main class="container-lg">
    <div class="d-flex justify-content-between mb-2 pb-2">
      <h3 class="fs-3">
        <span class="px-2 border-bottom border-2">Observation</span>
      </h3>
      <button class="btn btn-outline-info btn-sm px-3" id="observation-add" type="button">Add</button>
    </div>
    <div class="accordion" id="observation">
      <% observations.forEach((observation, i)=> { %>
        <div class="accordion-item">
          <h2 class="accordion-header" id="header-<%= i %>">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#content-<%= i %>" aria-expanded="false" aria-controls="content-<%= i %>">
              <%= observation.name %>
            </button>
          </h2>
          <div id="content-<%= i %>" class="accordion-collapse collapse" aria-labelledby="header-<%= i %>">
            <div class="accordion-body">
              <form method="post" action="/update">
                <input type="hidden" name="index" value="<%= i %>">
                <div class="row mb-2">
                  <div class="col-2">
                    <label for="name-<%= i %>" class="col-form-label">Name</label>
                  </div>
                  <div class="col-10">
                    <input type="text" name="name" id="name-<%= i %>" class="form-control"
                      value="<%= observation.name %>">
                  </div>
                </div>
                <div class="row mb-2">
                  <div class="col-2">
                    <label for="filepath-<%= i %>" class="col-form-label">FilePath</label>
                  </div>
                  <div class="col-10">
                    <input type="text" name="filePath" id="filepath-<%= i %>" class="form-control"
                      value="<%= observation.filePath %>">
                  </div>
                </div>
                <div class="mb-2">
                  <div class="d-flex justify-content-between mb-2">
                    <p class="fs-6">Triggers</p>
                    <button class="btn btn-outline-info btn-sm px-3" id="triggers-add-<%= i %>" type="button"
                      onclick="addTrigger(this)">Add</button>
                  </div>
                  <ul class="mb-2 list-group" id="triggers-<%= i %>">
                    <% observation.triggers.forEach((trigger, j)=> { %>
                      <li class="list-group-item">
                        <div class="row">
                          <div class="col-2">
                            <label for="pattern-<%= i %>-<%= j %>" class="col-form-label">Pattern</label>
                          </div>
                          <div class="col-10">
                            <input type="text" name="pattern" id="pattern-<%= i %>-<%= j %>" class="form-control"
                              value="<%= trigger.pattern %>">
                          </div>
                          <div class="col-2">
                            <label for="script-<%= i %>-<%= j %>" class="col-form-label">Script</label>
                          </div>
                          <div class="col-10">
                            <textarea name="script" id="script-<%= i %>-<%= j %>"
                              class="form-control"><%= trigger.script %></textarea>
                          </div>
                        </div>
                      </li>
                      <% }) %>
                  </ul>
                </div>
                <div class="mb-2 mt-3 d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary w-25">Update</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <% }) %>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript">
    document.querySelector('#observation-add').addEventListener('click', () => {
      const observationsElem = document.querySelector('#observation');
      const index = observationsElem.getElementsByTagName('form').length;
      const newElem = document.createElement('div');
      newElem.classList.add('accordion-item');
      newElem.innerHTML = `
        <h2 class="accordion-header" id="header-${index}">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#content-${index}" aria-expanded="true" aria-controls="content-${index}">
            Add Observation
          </button>
        </h2>
        <div id="content-${index}" class="accordion-collapse collapse show" aria-labelledby="header-${index}">
          <div class="accordion-body">
            <form method="post" action="/update">
              <input type="hidden" name="index" value="${index}">
              <div class="row mb-2">
                <div class="col-2">
                  <label for="name-${index}" class="col-form-label">Name</label>
                </div>
                <div class="col-10">
                  <input type="text" name="name" id="name-${index}" class="form-control">
                </div>
              </div>
              <div class="row mb-2">
                <div class="col-2">
                  <label for="filepath-${index}" class="col-form-label">FilePath</label>
                </div>
                <div class="col-10">
                  <input type="text" name="filePath" id="filepath-${index}" class="form-control">
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-2">
                  <p class="fs-6">Triggers</p>
                  <button class="btn btn-outline-info btn-sm px-3" id="triggers-add-${index}" type="button" onclick="addTrigger(this)">Add</button>
                </div>
                <ul class="mb-2 list-group" id="triggers-${index}"></ul>
              </div>
              <div class="mb-2 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary w-25">Update</button>
              </div>
            </form>
          </div>
        </div>
      `;
      observationsElem.appendChild(newElem);
    });

    const addTrigger = (e) => {
      const id = (e.id).replace('triggers-add-', '');
      const ulElem = document.querySelector('#triggers-' + id);
      const liIndex = ulElem.getElementsByTagName('li').length;
      const newLiElem = document.createElement('li');
      newLiElem.classList.add('list-group-item');
      newLiElem.innerHTML = `
        <div class="row">
          <div class="col-2">
            <label for="pattern-${id}-${liIndex}" class="col-form-label">Pattern</label>
          </div>
          <div class="col-10">
            <input type="text" name="pattern" id="pattern-${id}-${liIndex}" class="form-control">
          </div>
          <div class="col-2">
            <label for="script-${id}-${liIndex}" class="col-form-label">Script</label>
          </div>
          <div class="col-10">
            <textarea name="script" id="script-${id}-${liIndex}" class="form-control"></textarea>
          </div>
        </div>`;
      ulElem.appendChild(newLiElem);
    };
  </script>
</body>

</html>